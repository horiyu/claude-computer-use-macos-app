<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Claude Computer Use Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div id="chatContainer">
    <div id="log"></div>
  </div>
  <div id="inputForm">
    <input type="text" id="instruction" placeholder="例: Save an image of a cat to the desktop.">
    <button id="sendButton">
      <img src="{{ url_for('static', filename='imgs/send.svg') }}" alt="送信">
    </button>
  </div>
  <script>
    const logDiv = document.getElementById('log');
    const instructionInput = document.getElementById('instruction');
    const sendButton = document.getElementById('sendButton');

    // sender: "user" or "bot"
    function appendMessage(message, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender);

      const textDiv = document.createElement('div');
      textDiv.classList.add('text');
      textDiv.innerHTML = message;

      messageDiv.appendChild(textDiv);
      logDiv.appendChild(messageDiv);
      window.scrollTo(0, document.body.scrollHeight);
    }

    function sendInstruction() {
      const instruction = instructionInput.value.trim();
      if (!instruction) return;
      // ユーザメッセージを表示
      appendMessage("<strong>You:</strong> " + instruction, "user");
      instructionInput.value = "";
      fetch("/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "instruction=" + encodeURIComponent(instruction)
      }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        function read() {
          reader.read().then(({ done, value }) => {
            if (done) return;
            const chunk = decoder.decode(value);
            // 相手メッセージを表示
            appendMessage(chunk, "bot");
            read();
          });
        }
        read();
      }).catch(err => {
        console.error(err);
        appendMessage("エラーが発生しました。", "bot");
      });
    }

    sendButton.addEventListener('click', sendInstruction);
    instructionInput.addEventListener('keypress', function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        sendInstruction();
      }
    });
  </script>
</body>

</html>